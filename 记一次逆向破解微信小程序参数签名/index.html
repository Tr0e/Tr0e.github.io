<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Tr0e"><meta name="copyright" content="Tr0e"><meta name="generator" content="Hexo 5.4.2"><meta name="theme" content="hexo-theme-yun"><title>记一次逆向破解微信小程序参数签名 | Cyber Security</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.3.3/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"tr0e.github.io","root":"/","title":["Tr0e","Blog"],"version":"1.10.4","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","fireworks":{"colors":null},"vendors":{"darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="Cyber Security" type="application/atom+xml"><meta name="description" content="前言本文首发于 Freebuf 安全社区，未经许可谢绝转载！ 在一个平淡无奇的午后，接到一个新的活——对某微信小程序进行渗透测试。老规矩，倒了杯茶，准备开始新一天轰轰烈烈的干活（摸鱼）。 然鹅，BurpSuite 上号不到 2 min 我就发现今天的砖头有点烫手了（晚饭可能都不香了）……事情是这样的：没错，这货不讲武德，直接加了个时间戳参数timestamp、签名参数signature用来防止数据">
<meta property="og:type" content="article">
<meta property="og:title" content="记一次逆向破解微信小程序参数签名">
<meta property="og:url" content="https://tr0e.github.io/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8F%82%E6%95%B0%E7%AD%BE%E5%90%8D/index.html">
<meta property="og:site_name" content="Cyber Security">
<meta property="og:description" content="前言本文首发于 Freebuf 安全社区，未经许可谢绝转载！ 在一个平淡无奇的午后，接到一个新的活——对某微信小程序进行渗透测试。老规矩，倒了杯茶，准备开始新一天轰轰烈烈的干活（摸鱼）。 然鹅，BurpSuite 上号不到 2 min 我就发现今天的砖头有点烫手了（晚饭可能都不香了）……事情是这样的：没错，这货不讲武德，直接加了个时间戳参数timestamp、签名参数signature用来防止数据">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204135256163.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204151519578.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204151748614.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204154056998.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210204154835583.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTE5MDg5Nw==,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204155554283.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210204160036348.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTE5MDg5Nw==,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204160836483.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210204161035807.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTE5MDg5Nw==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204162627777.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2021020416422468.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTE5MDg5Nw==,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204170525870.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204170605552.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210204171631332.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTE5MDg5Nw==,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204172014399.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210204172039663.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTE5MDg5Nw==,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204172115473.png">
<meta property="article:published_time" content="2021-02-04T09:29:23.000Z">
<meta property="article:modified_time" content="2022-07-03T13:32:19.028Z">
<meta property="article:author" content="Tr0e">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204135256163.png"><script>(function() {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Tr0e"><img width="96" loading="lazy" src="/images/Tr0e.jpg" alt="Tr0e"></a><div class="site-author-name"><a href="/about/">Tr0e</a></div><span class="site-name">Cyber Security</span><sub class="site-subtitle"></sub><div class="site-description"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">8</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">4</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">0</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/about/" title="About Me" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E9%80%86%E5%90%91"><span class="toc-number">2.</span> <span class="toc-text">小程序逆向</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E5%82%A8%E5%A4%87"><span class="toc-number">2.1.</span> <span class="toc-text">基础知识储备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%86%E5%90%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">2.2.</span> <span class="toc-text">逆向环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E7%BC%96%E8%AF%91%E5%87%BA%E6%BA%90%E7%A0%81"><span class="toc-number">2.3.</span> <span class="toc-text">反编译出源码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A0%B4%E8%A7%A3%E7%AD%BE%E5%90%8D%E7%AE%97%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">破解签名算法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">源码算法分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E8%AE%A1%E7%AE%97%E7%AD%BE%E5%90%8D"><span class="toc-number">3.2.</span> <span class="toc-text">脚本计算签名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E8%87%AA%E5%8A%A8%E6%9B%BF%E6%8D%A2"><span class="toc-number">3.3.</span> <span class="toc-text">插件自动替换</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="https://tr0e.github.io/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8F%82%E6%95%B0%E7%AD%BE%E5%90%8D/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Tr0e"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Cyber Security"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">记一次逆向破解微信小程序参数签名</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="Created: 2021-02-04 17:29:23" itemprop="dateCreated datePublished" datetime="2021-02-04T17:29:23+08:00">2021-02-04</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">渗透测试</span></a></span></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文首发于 <a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/263394.html">Freebuf 安全社区</a>，未经许可谢绝转载！</p>
<p>在一个平淡无奇的午后，接到一个新的活——对某微信小程序进行渗透测试。老规矩，倒了杯茶，准备开始新一天轰轰烈烈的干活（摸鱼）。</p>
<p>然鹅，BurpSuite 上号不到 2 min 我就发现今天的砖头有点烫手了（晚饭可能都不香了）……事情是这样的：<br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204135256163.png" alt="在这里插入图片描述" loading="lazy">没错，这货不讲武德，直接加了个时间戳参数<code>timestamp</code>、签名参数<code>signature</code>用来防止数据包重放……那这还玩个锤子！</p>
<p>这我还能说啥，合上电脑准备睡觉！但下一秒还是理智占据了上峰……算了，不能跟 RMB 过不去，还是老实搬砖干活为妙！</p>
<h1 id="小程序逆向"><a href="#小程序逆向" class="headerlink" title="小程序逆向"></a>小程序逆向</h1><p>喝口茶冷静想想，既然做了参数签名验证，那么想要继续愉快地渗透测试，必须得解决如何随意替换签名值<code>signature</code>了，那也就是说必须拿到小程序生成签名的源码。</p>
<p>那么问题来了。Web 网站有前端 js 代码负责这活，直接 F12 开发者工具就能查看前端代码逻辑，但是微信小程序的客户端源码上哪找？？不装了摊牌了，先前确实还没干过这活，这大概就是要现场表演下传说中的从0到1了……</p>
<h2 id="基础知识储备"><a href="#基础知识储备" class="headerlink" title="基础知识储备"></a>基础知识储备</h2><p>打开搜索引擎一通搜索，了解了关于微信小程序源码几个核心的扫盲问题：</p>
<p><strong>1、微信小程序源码如何获得？</strong></p>
<p> 微信小程序客户端的源文件由开发者发布后会存放在微信官方的服务器上。用户在微信客户端访问小程序后，会将其客户端源码打包下载到本地（就像APP的客户端程序），所以我们可以在手机本地找到对应小程序客户端的安装包，并进一步进行反编译获得源码。</p>
<p><strong>2、微信小程序安装包存放在哪？</strong></p>
<p> 手机本地存放微信小程序安装包的具体目录位置为：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">/</span>data<span class="token operator">/</span>data<span class="token operator">/</span>com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>mm<span class="token operator">/</span>MicroMsg<span class="token operator">/</span><span class="token constant">XXXXXXXX</span><span class="token punctuation">(</span>命名很长的文件夹，据说是用户随机码）<span class="token operator">/</span>appbrand<span class="token operator">/</span>pkg<span class="token operator">/</span></code></pre>

<p>在这个目录下会发现一些 <code>xxxx.wxapkg</code> 类型的文件，这些就是微信小程序的安装包（二进制文件，还需要进一步进行反编译才能获得源码，类似获得 APP 的 APK 安装包后还需进一步进行反编译）。但是从上面的<code>/data/data</code>路径可以看出，必须 root 环境下的手机才能获取到目标文件。</p>
<p><strong>3、如何反编译小程序安装包？</strong></p>
<p>拿到 <code>xxxxx.wxapkg</code> 类型的微信小程序安装包以后，如何反编译获得小程序源码？大佬已经给我们写好现成的反编译脚本了，拿来即可食用：<a target="_blank" rel="noopener" href="https://gitee.com/ksd/wxappUnpacker">wxappUnpacker </a>。</p>
<h2 id="逆向环境准备"><a href="#逆向环境准备" class="headerlink" title="逆向环境准备"></a>逆向环境准备</h2><p>了解完上述知识，顿时觉得这活有盼头了，撸起袖子准备干。获取源码前，先来准备下逆向环境。</p>
<p>1、安装 node.js 运行环境</p>
<p>访问 <a target="_blank" rel="noopener" href="https://nodejs.org/zh-cn/download/">node 的下载地址</a>，下载安装后设置系统环境变量，成功后如下：<br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204151519578.png" alt="在这里插入图片描述" loading="lazy"><br>2、下载反编译脚本文件 <a target="_blank" rel="noopener" href="https://gitee.com/ksd/wxappUnpacker">wxappUnpacker </a>到本地并解压缩：<br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204151748614.png" alt="在这里插入图片描述" loading="lazy"><br>然后需要运行以下命令安装对应的依赖：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> esprima
<span class="token function">npm</span> <span class="token function">install</span> css-tree
<span class="token function">npm</span> <span class="token function">install</span> cssbeautify    
<span class="token function">npm</span> <span class="token function">install</span> vm2    
<span class="token function">npm</span> <span class="token function">install</span> uglify-es    
<span class="token function">npm</span> <span class="token function">install</span> js-beautify</code></pre>

<p>3、使用 DDMS（或者 adb、RE文件管理器）工具，从手机模拟器中找到并导出目标小程序的安装包：<br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204154056998.png" alt="在这里插入图片描述" loading="lazy"></p>
<blockquote>
<p>【注意】如果发现 pkg 文件夹下当前存在的<code>xxxxx.wxapkg</code> 安装包太多，分不清是哪一个的话，可以提前清空、删除 pkg 文件夹下的<code>xxxxx.wxapkg</code>文件，再重新运行目标小程序；同时注意多点击几下程序，使得手机能够从微信服务器下载完整的安装包（本人目标程序点击后生成了如图所示的4个<code>xxxxx.wxapkg</code>文件）。</p>
</blockquote>
<p>4、将目标小程序的安装包导出到本地，完成前期的准备工作：</p>
<p><img src="https://img-blog.csdnimg.cn/20210204154835583.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTE5MDg5Nw==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" loading="lazy"></p>
<h2 id="反编译出源码"><a href="#反编译出源码" class="headerlink" title="反编译出源码"></a>反编译出源码</h2><p>准备工作完成，接下来开始运行反编译脚本，对获取到的<code>xxxxx.wxapkg</code>安装包文件进行反编译，由于不知道 4 个安装包文件中哪个包含了我想要的参数签名的源码，那就只能逐个反编译出来看看了。</p>
<p>1、先看第一个，执行命令<code>node wuWxapkg.js + file</code>，运行脚本对目标文件进行反编译：</p>
<p><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204155554283.png" alt="在这里插入图片描述" loading="lazy"><br>2、运行结果如下，报错信息提醒当前反编译的包不是程序的主安装包：</p>
<p><img src="https://img-blog.csdnimg.cn/20210204160036348.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTE5MDg5Nw==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" loading="lazy"><br>3、既然如此，那就接着反编译下一个安装包文件，成功反编译：</p>
<p><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204160836483.png" alt="在这里插入图片描述" loading="lazy"><br>4、接着到<code>xxxxx.wxapkg</code>存储路径下查看反编译成功后自动生成的存放源码的文件夹，可以看到已经成功获取到目标小程序的客户端源码：<br><img src="https://img-blog.csdnimg.cn/20210204161035807.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTE5MDg5Nw==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"><br>至此，烫手的砖头搬完一半了，可以准备点个外卖吃晚饭了~</p>
<h1 id="破解签名算法"><a href="#破解签名算法" class="headerlink" title="破解签名算法"></a>破解签名算法</h1><p>吃饭先搁一边，继续肝，破解完签名算法，晚饭才能吃得香哈哈（干饭人）。</p>
<h2 id="源码算法分析"><a href="#源码算法分析" class="headerlink" title="源码算法分析"></a>源码算法分析</h2><p>1、在 VS Code 打开源码文件夹，搜索 <code>sign</code> 关键词，发现<code>request.js</code>文件存在疑似签名函数：<br><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204162627777.png" alt="在这里插入图片描述" loading="lazy">2、经过审计分析，该位置确实是要找的目标签名函数，签名大致流程是 <code>MD5(固定盐值+时间戳timestamp)</code>，核心代码如下：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">get_signature_timestamp</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">var</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
       <span class="token literal-property property">timestamp</span><span class="token operator">:</span> e<span class="token punctuation">,</span>
       <span class="token literal-property property">signature</span><span class="token operator">:</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token string">"SvZy7GUy5mqWk15l4F3Ivb1IXCWOhnAm"</span> <span class="token operator">+</span> e<span class="token punctuation">)</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>3、接下来使用 MD5 在线加密验证一下，确认已成功找到签名算法：</p>
<p><img src="https://img-blog.csdnimg.cn/2021020416422468.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTE5MDg5Nw==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" loading="lazy"><br>既然知道目标小程序如何计算签名参数了，那么接下来，就可以使用 <a target="_blank" rel="noopener" href="https://tool.lu/timestamp/">在线生成时间戳的网站</a> 结合 <a target="_blank" rel="noopener" href="https://www.cmd5.com/hash.aspx?s=123456">MD5 在线转换网站</a> 来计算新的签名值，然后手动替换数据包中对应的时间戳、签名值进行重放。实测发现这种做法虽然可以成功重放数据包，然而，这样子测试的话特别折腾！</p>
<p>难以忍受这种测试方式的龟速不说，进一步测试还发现，由于有时从浏览器复制计算出的新签名值到 BurpSuite 进行黏贴的过程手速太慢，会导致签名失效……此处猜测目标小程序的服务端应该校验了发送请求中包含的时间戳与服务器接收到请求时的时间戳之间的时间间隔，间隔太久的话则返回 400 报错。</p>
<h2 id="脚本计算签名"><a href="#脚本计算签名" class="headerlink" title="脚本计算签名"></a>脚本计算签名</h2><p>作为 21 世纪的新一代青年，自然不能忍受这种机械式体力活，于是乎，掏出 IDEA，编写脚本自动计算新的时间戳和签名值：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">MessageDigest</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MD5Test</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toMD5</span><span class="token punctuation">(</span><span class="token class-name">String</span> plainText<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//生成实现指定摘要算法的 MessageDigest 对象。</span>
            <span class="token class-name">MessageDigest</span> md <span class="token operator">=</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"MD5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            plainText<span class="token operator">=</span><span class="token string">"SvZy7GUy5mqWk15l4F3Ivb1IXCWOhnAm"</span><span class="token operator">+</span>plainText<span class="token punctuation">;</span>
            <span class="token comment">//使用指定的字节数组更新摘要。</span>
            md<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>plainText<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//通过执行诸如填充之类的最终操作完成哈希计算。</span>
            <span class="token keyword">byte</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> md<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//生成具体的md5密码到buf数组</span>
            <span class="token keyword">int</span> i<span class="token punctuation">;</span>
            <span class="token class-name">StringBuffer</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> offset <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">;</span> offset<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                i <span class="token operator">=</span> b<span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    i <span class="token operator">+=</span> <span class="token number">256</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span>
                    buf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                buf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> plainText<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取当前时间戳，精确到毫秒;然后计算对应的签名值</span>
        <span class="token keyword">long</span> now_time<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前新的时间戳 timestamp："</span><span class="token operator">+</span>now_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> now_sign<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">MD5Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMD5</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>now_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前新的签名值 signature："</span><span class="token operator">+</span>now_sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>运行脚本获得新的时间戳和签名值如下：</p>
<p><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204170525870.png" alt="在这里插入图片描述" loading="lazy"><br>成功利用计算所得的新的时间戳和签名值进行数据包重放：</p>
<p><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204170605552.png" alt="在这里插入图片描述" loading="lazy"></p>
<h2 id="插件自动替换"><a href="#插件自动替换" class="headerlink" title="插件自动替换"></a>插件自动替换</h2><p>本来到这里已经可以愉快地次饭去了，但是，作为 21 世纪的新一代青年……理应追求极致效率（说到底上面复制黏贴还是太麻烦了）！</p>
<p>于是乎，继续掏出 IDEA，编写 BurpSuite 插件，实现 Repeater 模块重放数据包时，会自动计算新的时间戳、签名值并自动替换，达到全自动的效果。</p>
<p>不废话了，直接放上插件最终的核心源码<code>BurpExtender.java</code>（关于 BurpSuite 插件编写的基础知识请自行百度……）：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">burp</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">PrintWriter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">MessageDigest</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BurpExtender</span> <span class="token keyword">implements</span> <span class="token class-name">IBurpExtender</span><span class="token punctuation">,</span> <span class="token class-name">IHttpListener</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// implement IBurpExtender</span>
    <span class="token keyword">private</span> <span class="token class-name">PrintWriter</span> stderr<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">PrintWriter</span> stdout<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">IExtensionHelpers</span> helpers<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerExtenderCallbacks</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">burp<span class="token punctuation">.</span></span>IBurpExtenderCallbacks</span> callbacks<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        callbacks<span class="token punctuation">.</span><span class="token function">setExtensionName</span><span class="token punctuation">(</span><span class="token string">"My Sign Plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stdout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span><span class="token function">getStdout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stderr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span><span class="token function">getStderr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stdout<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Success!Enjoy it!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>helpers <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">getHelpers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        callbacks<span class="token punctuation">.</span><span class="token function">registerHttpListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//processHttpMessage handle requests and responses from HttpListener</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processHttpMessage</span><span class="token punctuation">(</span><span class="token keyword">int</span> toolFlag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> messageIsRequest<span class="token punctuation">,</span> <span class="token class-name">IHttpRequestResponse</span> messageInfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Process only Repeater, Scanner and Intruder requests</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>toolFlag <span class="token operator">==</span> <span class="token class-name">IBurpExtenderCallbacks</span><span class="token punctuation">.</span>TOOL_SCANNER <span class="token operator">||</span>
                toolFlag <span class="token operator">==</span> <span class="token class-name">IBurpExtenderCallbacks</span><span class="token punctuation">.</span>TOOL_REPEATER <span class="token operator">||</span>
                toolFlag <span class="token operator">==</span> <span class="token class-name">IBurpExtenderCallbacks</span><span class="token punctuation">.</span>TOOL_INTRUDER <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>messageIsRequest<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token comment">//处理请求数据包</span>
                <span class="token class-name">Handle_Request_Packet</span><span class="token punctuation">(</span>messageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//处理返回数据包</span>
                <span class="token class-name">Handle_Response_Packet</span><span class="token punctuation">(</span>messageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//处理请求数据包</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token class-name">Handle_Request_Packet</span><span class="token punctuation">(</span><span class="token class-name">IHttpRequestResponse</span> messageInfo<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//获取请求数据包</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> request <span class="token operator">=</span> messageInfo<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IRequestInfo</span> requestInfo <span class="token operator">=</span> helpers<span class="token punctuation">.</span><span class="token function">analyzeRequest</span><span class="token punctuation">(</span>messageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//String url = requestInfo.getUrl().toString();</span>
        <span class="token keyword">int</span> bodyOffset <span class="token operator">=</span> requestInfo<span class="token punctuation">.</span><span class="token function">getBodyOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取所有的请求头</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> headers <span class="token operator">=</span> requestInfo<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取所有的请求body体</span>
        <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>bodyOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"signature"</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            stdout<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Before change：\n"</span> <span class="token operator">+</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//计算当前的时间戳和签名值</span>
            <span class="token keyword">long</span> new_time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> new_sign <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BurpExtender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMD5</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>new_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//提取原始请求中的时间戳和签名值</span>
            <span class="token keyword">int</span> time_start <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"&amp;timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> oldtimestamp <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>time_start <span class="token operator">+</span> <span class="token number">11</span><span class="token punctuation">,</span> time_start <span class="token operator">+</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> sign_start <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"&amp;signature="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> oldsign <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>sign_start <span class="token operator">+</span> <span class="token number">11</span><span class="token punctuation">,</span> sign_start <span class="token operator">+</span> <span class="token number">43</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//替换原始请求中的时间戳和签名值</span>
            body <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>oldtimestamp<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>new_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            body <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>oldsign<span class="token punctuation">,</span> new_sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//修改后的数据替换原始的请求包</span>
            <span class="token class-name">String</span> newBody <span class="token operator">=</span> body<span class="token punctuation">;</span>
            stdout<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"After change:\n"</span> <span class="token operator">+</span> newBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//重构数据包的目的是因为修改完请求体body后，需要将请求头head和请求体body重新拼接起来后再发送给服务器</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bodyByte <span class="token operator">=</span> newBody<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> new_Request <span class="token operator">=</span> helpers<span class="token punctuation">.</span><span class="token function">buildHttpMessage</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> bodyByte<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//stdout.println("After change:\n" + new String(new_Request));</span>
            messageInfo<span class="token punctuation">.</span><span class="token function">setRequest</span><span class="token punctuation">(</span>new_Request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//处理返回数据包</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token class-name">Handle_Response_Packet</span><span class="token punctuation">(</span><span class="token class-name">IHttpRequestResponse</span> messageInfo<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//忽略，无需做任何处理</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toMD5</span><span class="token punctuation">(</span><span class="token class-name">String</span> plainText<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//生成实现指定摘要算法的 MessageDigest 对象。</span>
            <span class="token class-name">MessageDigest</span> md <span class="token operator">=</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"MD5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            plainText<span class="token operator">=</span><span class="token string">"SvZy7GUy5mqWk15l4F3Ivb1IXCWOhnAm"</span><span class="token operator">+</span>plainText<span class="token punctuation">;</span>
            <span class="token comment">//使用指定的字节数组更新摘要。</span>
            md<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>plainText<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//通过执行诸如填充之类的最终操作完成哈希计算。</span>
            <span class="token keyword">byte</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> md<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//生成具体的md5密码到buf数组</span>
            <span class="token keyword">int</span> i<span class="token punctuation">;</span>
            <span class="token class-name">StringBuffer</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> offset <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">;</span> offset<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                i <span class="token operator">=</span> b<span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    i <span class="token operator">+=</span> <span class="token number">256</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span>
                    buf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                buf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> plainText<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>来看看不使用插件的情况下，直接重放上面的数据包的结果：</p>
<p><img src="https://img-blog.csdnimg.cn/20210204171631332.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTE5MDg5Nw==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" loading="lazy"><br>最后上大招，从 IDEA 导出、生成 jar 插件文件并导入 BurpSuite：</p>
<p><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204172014399.png" alt="在这里插入图片描述" loading="lazy"><br>下面就是见证奇迹的时候了！来看看这时候重放数据包的效果：</p>
<p><img src="https://img-blog.csdnimg.cn/20210204172039663.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTE5MDg5Nw==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" loading="lazy"><br>成功重放hh，同时可以在插件的输出日志里查看到时间戳和签名值的自动替换记录：</p>
<p><img src="https://raw.githubusercontent.com/Tr0e/PiCGo/main/img/20210204172115473.png" alt="在这里插入图片描述" loading="lazy"><br>至此，就可以愉快地继续进行渗透测试啦！</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本次测试过程从0到1接触了微信小程序的逆向，首先通过审计分析出计算参数签名的源码逻辑，接着编写了自动计算的时间戳和签名值的脚本，再到最后开发 BurpSuite 自动化插件，这过程也算小有收获了。</p>
<p>最后总结下进一步思考的几个问题：</p>
<ol>
<li>实际上很多进行参数签名校验的系统的会采用对整个数据包的参数进行签名的方式，而非像本文所述的案例（只是对时间戳进行 MD5 哈希加盐），具体的签名算法破解需要逆向分析不同系统的源码；</li>
<li>时间戳和参数签名确实是防止数据篡改、重放的有力措施，而这个过程安全性的保障的核心在于防止签名算法中的加密密钥 secret （即本文案例中的硬编码盐值）泄露；</li>
<li>开发人员可通过对微信小程序客户端进行安全加固（如代码混淆）的方式来增加攻击者分析、获取加密密钥的难度。</li>
</ol>
<p>从本次测试也可以看出，开发人员不应该过度依赖客户端参数签名机制抵御网络攻击，应该着重于重视、强化服务端代码自身业务逻辑的安全性！</p>
</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>Tr0e</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://tr0e.github.io/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8F%82%E6%95%B0%E7%AD%BE%E5%90%8D/" title="记一次逆向破解微信小程序参数签名">https://tr0e.github.io/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8F%82%E6%95%B0%E7%AD%BE%E5%90%8D/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> unless otherwise stated.</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/Python%E6%94%BB%E9%98%B2-Fuzz%E7%BB%95%E8%BF%87%E5%AE%89%E5%85%A8%E7%8B%97%E8%BF%9B%E8%A1%8CSQL%E6%B3%A8%E5%85%A5/" rel="prev" title="Python攻防-Fuzz绕过安全狗进行SQL注入"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">Python攻防-Fuzz绕过安全狗进行SQL注入</span></a></div><div class="post-nav-item"></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2022 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> Tr0e</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v5.4.2</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.4</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></body></html>